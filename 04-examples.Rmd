---
title: "Regression modelling using I-priors"
subtitle: NUS Department of Statistics & Data Science Seminar
author: "Haziq Jamil"
date: "Wednesday, 16 November 2022"
institute: |
  | Mathematical Sciences, Faculty of Science, UBD
  | \url{https://haziqj.ml}
output: 
  beamer_presentation:
    template: ubd_beamer_rmd.tex
    latex_engine: xelatex
    slide_level: 3
    keep_tex: false
    citation_package: biblatex
    pandoc_args: ["--lua-filter=/Library/Frameworks/R.framework/Versions/4.2/Resources/library/bookdown/rmarkdown/lua/custom-environment.lua"]    
    # includes:
    #   after_body: afterbody.txt
toc: true
toctitle: "Overview"
banner: true
logo: true
progressdots: true
transitions: true
handout: false
bibliography: refs.bib
refslide: false
aspectratio: 43
editor_options: 
  markdown: 
    wrap: 72
# header-includes:
#   - \usetikzlibrary{backgrounds,calc,intersections}
#   - \usepackage{pgfplots}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, fig.height = 3.2, fig.width = 6, cache = TRUE,
  cache.path = "_cache/", fig.path = "figure/", warning = FALSE, message = FALSE,
  fig.align = "center"
)
options(width = 55)  # if 4:3 set to 55, otherwise 70
library(tidyverse)
library(iprior)
library(directlabels)
theme_set(
  theme_classic() +
      theme(
        # axis.title.x = element_text(hjust = 1),
        # axis.title.y = element_text(angle = 0),
        axis.ticks = element_blank(),
        axis.text = element_blank()
      )
)

navyblue <- "#002f5c"
solidpink <- "#8E3B46"
```

# Data examples

## Longitudinal analysis of growth of cattle

> \textcolor{navyblue}{Aim:  Discern whether there is a difference between two treatments given to cows, and whether this effect varies among individual cows.}

Data consists of a balanced longitudinal set of weights $y_{it}$ for 60 cows.
The herd were randomly split between two treatment groups ($x_i$).
Model
$$
y_{it} = f_{1t}(i) + f_{2t}(x_i) + f_{12t}(i, x_i) + \epsilon_{it}
$$
assuming smooth effect of time, and nominal effect of cow index and treatment group. 
\small

|   | Explanation                           | Model               | Log-lik. |   No. of param. |
|---|---------------------------------------|---------------------|---------:|----------------:|
| 1 | Growth due to cows only               | $$f_{1t}$$          |  $-2792.2$ |               3 | 
| 2 | Growth due to treatment only          | $$f_{2t}$$          |  $-2295.2$ |               3 | 
| 3 | Growth due to both  | $$f_{1t} + f_{2t}$$ |  $-2270.9$ |               4 |
| 4 | Growth due to both with cow-treatment variation | $$f_{1t} + f_{2t} + f_{12t}$$ | $-2250.9$ | 4 |  

### Growth curve

```{r cowgrowth, fig.height = 3.7}
data(cattle, package = "jmcm")
names(cattle) <- c("id", "time", "group", "weight")
cattle$id <- as.factor(cattle$id)  # convert to factors
levels(cattle$group) <- c("Treatment A", "Treatment B")

# Model 5: weight ~ f(time:cow:treatment)
# mod5 <- iprior(weight ~ id * group * time, cattle, kernel = "fbm")
lambda <- c(-3.3405112, -0.9171739, -0.0470558)
psi <- 0.06549954
mod5 <- iprior(weight ~ id * group * time, cattle, kernel = "fbm", 
               lambda = lambda, psi = psi, fixed.hyp = TRUE)

cattle %>%
  group_by(id) %>%
  complete(time = 0:133) %>%
  # group_by(id, group, weight) %>%
  fill(group, weight) %>%
  ungroup() -> df_pred

tmp <- predict(mod5, newdata = as.data.frame(df_pred))

df_pred %>%
  mutate(y = tmp$y) %>%
  ggplot(aes(time, y, group = id, col = weight)) +
  geom_line() +
  # geom_point(data = cattle, aes(time, weight)) +
  facet_grid(. ~ group) +
  scale_colour_viridis_c() +
  guides(col = "none") +
  theme_classic() +
  labs(x = "Time (days)", y = "Weight (kg)")
```

## Predicting fat content in meat samples

> \textcolor{navyblue}{Aim: Predict fat content of meat samples from its spectrometric curves (Tecator data set).}

For each meat sample $i$, data consist of 100 channel spectrum of absorbances ($x_i(t)$) and its corresponding fat content ($y_i$).
Train/test split is 160 + 55.
Model
$$
y_i = f(x_i) + \epsilon_i
$$
where $x_i$ is the $i$th spectral curve. 

\vspace{0.5em}

```{r functionalx, fig.height = 2.5, fig.width = 8}
# Load data set
data(tecator, package = "caret")
endpoints <- as_tibble(endpoints)
colnames(endpoints) <- c("water", "fat", "protein")
absorp <- as_tibble(absorp)
colnames(absorp) <- seq(850, 1050, length = 100)

dat <-
  bind_cols(id = seq_len(nrow(endpoints)), endpoints, absorp) %>%
  slice_sample(n = 100)

p1 <- ggplot(dat, aes(x = 1, y = fat)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, aes(col = fat)) +
  scale_color_viridis_c() +
  scale_x_continuous(breaks = 1, label = " ") +
  guides(col = "none") +
  labs(x = " ", y = "Fat content (%)") +
  theme_classic() +
  theme(axis.ticks.x = element_blank())

p2 <- dat %>%
  pivot_longer(cols = `850`:`1050`, names_to = "x") %>%
  ggplot(aes(as.numeric(x), value, col = fat, group = id)) +
  geom_line() +
  scale_color_viridis_c() +
  guides(col = "none") +
  theme_classic() +
  labs(x = "Wavelength (nm)", y = "Absorbance")

cowplot::plot_grid(p1, p2, rel_widths = c(1, 3), labels = c("y", "x"))
```

### Results

\begin{table}[t!]
\centering
\begin{tabular}{p{9cm}rr}
\toprule
&\multicolumn{2}{c}{RMSE} \\
\cline{2-3}
Model & Train & Test \\
\midrule
\emph{I-prior} \\
\hspace{0.5em} Linear
& 2.89
& 2.89 \\
\hspace{0.5em} Quadratic
& 0.72
& 0.97 \\
\hspace{0.5em} Smooth (fBm-0.70)
& 0.19
& 0.63 \\[0.5em]
\emph{Others} \\
\hspace{0.5em} Linear functional regression      && 2.78 \\
\hspace{0.5em} Quadratic functional regression    && 0.80 \\
\hspace{0.5em} Gaussian process regression       && 2.93 \\
\hspace{0.5em} Neural networks                   && 0.36 \\
\hspace{0.5em} Kernel smoothing                  && 1.49 \\
\hspace{0.5em} Multivariate adaptive regression splines (MARS)                              && 0.88 \\
\hspace{0.5em} Functional additive regression (CSEFAM)                          && 0.85 \\
\bottomrule
\end{tabular}
\end{table}
